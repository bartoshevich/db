{# =================================================================== #}
{# === blog-extras.njk === #}
{# === Полная и единственная логика для раздела /blog/ === #}
{# =================================================================== #}

{% set pageUrl = page and page.url or '' %}
{% set isBlogListing = pageUrl == '/blog/' %}
{% set isBlogPost = pageUrl and pageUrl != '/blog/' and pageUrl.startsWith('/blog/') %}

{# --- СЛУЧАЙ 1: Главная страница блога (/blog/) --- #}
{# Логика для главной страницы блога. Остается без изменений. #}
{% if isBlogListing and collections.post %}

  {# 1. Собираем ItemList со всеми статьями #}
  {% set blogPostItems = [] %}
  {% for post in collections.post %}
    {% set postUrl = site.url ~ post.url %}
    {% set blogPosting = {
      "@type": "BlogPosting",
      "@id": postUrl,
      "url": postUrl,
      "name": (post.data.title.val or post.data.title) | decodeEntities,
      "headline": (post.data.title.val or post.data.title) | decodeEntities,
      "author": { "@id": "https://bartoshevich.by/about/#person" },
      "datePublished": post.date | isoDate
    } %}
    {% if post.data.last_modified_at %}
      {% set blogPosting = blogPosting | setAttribute("dateModified", post.data.last_modified_at | isoDate) %}
    {% endif %}
    {% if post.data.image %}
      {% set blogPosting = blogPosting | setAttribute("image", site.url ~ post.data.image) %}
    {% endif %}

    {% set listItem = {
      "@type": "ListItem",
      "position": loop.index,
      "item": blogPosting
    } %}
    {% set _ = blogPostItems.push(listItem) %}
  {% endfor %}

  {% set blogItemList = {
    "@type": "ItemList",
    "itemListElement": blogPostItems,
    "numberOfItems": blogPostItems | length
  } %}

  {# 2. Создаем финальный объединенный объект ["WebPage", "Blog"] #}
  {% set finalBlogObject = {
    "@type": ["WebPage", "Blog"],
    "@id": site.url ~ page.url,
    "url": site.url ~ page.url,
    "name": (title.val or title) | decodeEntities,
    "description": (description.val or description) | decodeEntities,
    "inLanguage": "ru",
    "datePublished": page.date | isoDate,
    "dateModified": last_modified_at | default(config.buildDate) | isoDate,
    "isPartOf": { "@id": site.url ~ "#website" },
    "author": { "@id": "https://bartoshevich.by/about/#person" },
    "publisher": { "@id": "https://bartoshevich.by/#organization" },
    "mainEntity": blogItemList,
    "hasPart": [
      { "@id": "https://bartoshevich.by/#subscription" }
    ]
  } %}

  {# 3. Добавляем этот единственный, но полный объект в граф #}
  {% set _ = schemaParts.push(finalBlogObject) %}


{# --- СЛУЧАЙ 2: Отдельная статья блога (/blog/post/) --- #}
{# Этот блок теперь полностью отвечает за генерацию схемы для постов #}
{% elif isBlogPost %}

  {# ШАГ 2.1: Создаем "легковесный" узел Blog для корректной связи #}
  {% set blogSchema = {
    "@type": "Blog",
    "@id": site.url ~ "/blog/",
    "url": site.url ~ "/blog/",
    "name": "Блог Дмитрия Бартошевича: маркетинг, стратегия, брендинг",
    "author": { "@id": "https://bartoshevich.by/about/#person" },
    "publisher": { "@id": "https://bartoshevich.by/#organization" }
  } %}
  {% set _ = schemaParts.push(blogSchema) %}

  {# ШАГ 2.2: Создаем и ОБОГАЩАЕМ узел WebPage #}
  {% set webPage = {
    "@type": "WebPage",
    "@id": (page.url | absoluteUrl(site.url)),
    "url": (page.url | absoluteUrl(site.url)),
    "name": (title.val or title) | decodeEntities | replace('"', '\\"'),
    "description": (description.val or description) | decodeEntities | replace('"', '\\"'),
    "inLanguage": "ru",
    "datePublished": page.date | isoDate,
    "dateModified": last_modified_at | default(config.buildDate) | isoDate,
    "isPartOf": { "@id": "https://bartoshevich.by/#website" },
    "mainEntity": { "@id": (page.url | absoluteUrl(site.url)) ~ "#post" }
  } %}

 
    {# Обработка FAQ (если есть) #}
  {% if faq %}
    {% set faqItems = [] %}
    {% for item in faq %}
      {% set faqItem = { "@type": "Question", "name": item.question, "acceptedAnswer": { "@type": "Answer", "text": item.answer } } %}
      {% set _ = faqItems.push(faqItem) %}
    {% endfor %}
    {% set faqPageSchema = { "@type": "FAQPage", "@id": (page.url | absoluteUrl(site.url)) ~ "#faq", "mainEntity": faqItems } %}
    {% set _ = schemaParts.push(faqPageSchema) %}
    
    {% set blogPosting = blogPosting | setAttribute("hasPart", { "@id": (page.url | absoluteUrl(site.url)) ~ "#faq" }) %}
  {% endif %}





  {# Обработка постов с фильмами #}
  {% if mainEntitySource == "films" and films and films.items %}
    {% set movieItems = [] %}
    {% for film in films.items %}
      {% set itemType = "TVSeries" if film.item_type == "TVSeries" else "Movie" %}
      {% set movieObject = {
        "@type": itemType,
        "url": site.url ~ page.url ~ "#" ~ film.id,
        "name": film.title_ru | replace('"', '\\"'),
        "alternateName": film.title_en | replace('"', '\\"'),
        "image": film.image if film.image else "https://i.ytimg.com/vi/" ~ film.trailer_yt_id ~ "/maxresdefault.jpg",
        "description": film.description | replace('"', '\\"'),
        "datePublished": film.year,
        "director": { "@type": "Person", "name": film.director.name }
      } %}

      {% if film.imdb_id %}
        {% set imdbUrl = "https://www.imdb.com/title/" ~ film.imdb_id ~ "/" %}
        {% set movieObject = movieObject | setAttribute("sameAs", imdbUrl) %}
      {% endif %}

      {% if film.reviews and (film.reviews | length) > 0 %}
        {% set reviewList = [] %}
        {% for review in film.reviews %}
          {% set reviewObject = { "@type": "Review", "reviewBody": review.text, "reviewRating": { "@type": "Rating", "ratingValue": review.rating, "bestRating": 10, "worstRating": 1 }, "author": { "@type": "Person", "name": review.author.name } } %}
          {% set _ = reviewList.push(reviewObject) %}
        {% endfor %}
        {% set movieObject = movieObject | setAttribute("review", reviewList) %}
      {% endif %}

      {% if film.imdb_rating and film.imdb_rating_count %}
        {% set movieObject = movieObject | setAttribute("aggregateRating", { "@type": "AggregateRating", "ratingValue": film.imdb_rating, "ratingCount": film.imdb_rating_count, "bestRating": 10, "worstRating": 1 }) %}
      {% elif film.imdb_rating %}
        {% set imdbReview = { "@type": "Review", "author": { "@type": "Organization", "name": "IMDb" }, "reviewBody": "Рейтинг IMDb: " ~ film.imdb_rating ~ "/10", "reviewRating": { "@type": "Rating", "ratingValue": film.imdb_rating, "bestRating": 10, "worstRating": 1 } } %}
        {% set existingReviews = movieObject.review or [] %}
        {% set _ = existingReviews.push(imdbReview) %}
        {% set movieObject = movieObject | setAttribute("review", existingReviews) %}
      {% endif %}
      
      {% set listItem = { "@type": "ListItem", "position": loop.index, "item": movieObject } %}
      {% set _ = movieItems.push(listItem) %}
    {% endfor %}

    {% set movieItemList = {
      "@type": "ItemList",
      "name": (title.val or title) | decodeEntities,
      "itemListOrder": "https://schema.org/ItemListOrderAscending",
      "numberOfItems": movieItems | length,
      "itemListElement": movieItems
    } %}
    
    {# Размещаем ItemList как mainEntity на WebPage, перезаписывая возможную ссылку на FAQ, т.к. фильмы важнее #}
    {% set webPage = webPage | setAttribute("mainEntity", movieItemList) %}
  {% endif %}

  {# Отправляем финальный, полностью собранный WebPage в граф #}
  {% set _ = schemaParts.push(webPage) %}

  {# ШАГ 2.3: Создаем и ОБОГАЩАЕМ узел BlogPosting #}
  {% set imageUrl = image | default('/assets/images/main/bartoshevichby.png') %}
  {% set blogPosting = {
    "@type": "BlogPosting",
    "@id": (page.url | absoluteUrl(site.url)) ~ "#post",
    "url": (page.url | absoluteUrl(site.url)),
    "headline": (title.val or title) | decodeEntities | replace('"', '\\"'),
    "author": { "@id": "https://bartoshevich.by/about/#person" },
    "publisher": { "@id": "https://bartoshevich.by/#organization" },
    "description": (description.val or description) | decodeEntities | replace('"', '\\"'),
    "image": site.url ~ imageUrl,
    "datePublished": page.date | isoDate,
    "dateModified": last_modified_at | default(config.buildDate) | isoDate,
    "mainEntityOfPage": { "@id": (page.url | absoluteUrl(site.url)) },
    "isPartOf": { "@id": site.url ~ "/blog/" }
  } %}

  {# Добавляем опциональные поля, если есть контент #}
  {% if content %}
    {% set blogPosting = blogPosting | setAttribute("wordCount", content | decodeEntities | wordcount) %}
    {% set blogPosting = blogPosting | setAttribute("timeRequired", content | readingTimeISO) %}
  {% endif %}

  {# Добавляем цитаты, если они есть в Front Matter #}
  {% if citations %}
    {% set citationObjects = [] %}
    {% for citation in citations %}
      {% set citationObject = { "@type": citation.type | default("WebPage"), "name": citation.name, "url": citation.url } %}
      {% set _ = citationObjects.push(citationObject) %}
    {% endfor %}
    {% set blogPosting = blogPosting | setAttribute("citation", citationObjects) %}
  {% endif %}

  {# Отправляем финальный, полностью собранный BlogPosting в граф #}
  {% set _ = schemaParts.push(blogPosting) %}

{% endif %}
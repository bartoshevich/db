{# =================================================================== #}
{# === blog-extras.njk === #}
{# === Полная и единственная логика для раздела /blog/ === #}
{# =================================================================== #}

{% set pageUrl = page and page.url or '' %}
{% set isBlogListing = pageUrl == '/blog/' %}
{% set isBlogPost = pageUrl and pageUrl != '/blog/' and pageUrl.startsWith('/blog/') %}

{# --- СЛУЧАЙ 1: Главная страница блога (/blog/) --- #}
{# Логика для главной страницы блога. Остается без изменений. #}
{% if isBlogListing and collections.post %}

  {# 1. Собираем ItemList со всеми статьями #}
  {% set blogPostItems = [] %}
  {% for post in collections.post %}
    {% set postUrl = site.url ~ post.url %}
    {% set blogPosting = {
      "@type": "BlogPosting",
      "@id": postUrl,
      "url": postUrl,
      "name": (post.data.title.val or post.data.title) | decodeEntities,
      "headline": (post.data.title.val or post.data.title) | decodeEntities,
      "author": { "@id": "https://bartoshevich.by/about/#person" },
      "datePublished": post.date | isoDate
    } %}
    {% if post.data.last_modified_at %}
      {% set blogPosting = blogPosting | setAttribute("dateModified", post.data.last_modified_at | isoDate) %}
    {% endif %}
    {% if post.data.image %}
      {% set blogPosting = blogPosting | setAttribute("image", site.url ~ post.data.image) %}
    {% endif %}

    {% set listItem = {
      "@type": "ListItem",
      "position": loop.index,
      "item": blogPosting
    } %}
    {% set _ = blogPostItems.push(listItem) %}
  {% endfor %}

  {% set blogItemList = {
    "@type": "ItemList",
    "itemListElement": blogPostItems,
    "numberOfItems": blogPostItems | length
  } %}

  {# 2. Создаем финальный объединенный объект ["WebPage", "Blog"] #}
  {% set finalBlogObject = {
    "@type": ["WebPage", "Blog"],
    "@id": site.url ~ page.url,
    "url": site.url ~ page.url,
    "name": (title.val or title) | decodeEntities,
    "description": (description.val or description) | jsonLdText,
    "inLanguage": "ru",
    "datePublished": page.date | isoDate,
    "dateModified": last_modified_at | default(config.buildDate) | isoDate,
    "isPartOf": { "@id": site.url ~ "#website" },
    "author": { "@id": "https://bartoshevich.by/about/#person" },
    "publisher": { "@id": "https://bartoshevich.by/about/#person" },
    "mainEntity": blogItemList,
    "potentialAction": {
      "@type": "SearchAction",
      "target": {
        "@type": "EntryPoint",
        "urlTemplate": site.url ~ "/blog/?q={search_term_string}"
      },
      "query-input": "required name=search_term_string"
    },
    "hasPart": [
      { "@id": "https://bartoshevich.by/#subscription" }
    ]
  } %}
  {% if breadcrumbId %}
    {% set finalBlogObject = finalBlogObject | setAttribute("breadcrumb", { "@id": breadcrumbId }) %}
  {% endif %}

  {# 3. Добавляем этот единственный, но полный объект в граф #}
  {% set _ = schemaParts.push(finalBlogObject) %}


{# --- СЛУЧАЙ 2: Отдельная статья блога (/blog/post/) --- #}
{# Этот блок теперь полностью отвечает за генерацию схемы для постов #}
{% elif isBlogPost %}

  {# ШАГ 2.1: Создаем "легковесный" узел Blog для корректной связи #}
  {% set blogSchema = {
    "@type": "Blog",
    "@id": site.url ~ "/blog/",
    "url": site.url ~ "/blog/",
    "name": "Блог Дмитрия Бартошевича: маркетинг, стратегия, брендинг",
    "author": { "@id": "https://bartoshevich.by/about/#person" },
    "publisher": { "@id": "https://bartoshevich.by/about/#person" }
  } %}
  {% set _ = schemaParts.push(blogSchema) %}

  {# ШАГ 2.2: Создаем и ОБОГАЩАЕМ узел WebPage #}
  {% set webPage = {
    "@type": "WebPage",
    "@id": (page.url | absoluteUrl(site.url)),
    "url": (page.url | absoluteUrl(site.url)),
    "name": (title.val or title) | decodeEntities | replace('"', '\\"'),
    "description": (description.val or description) | jsonLdText,
    "inLanguage": "ru",
    "datePublished": page.date | isoDate,
    "dateModified": last_modified_at | default(config.buildDate) | isoDate,
    "isPartOf": { "@id": "https://bartoshevich.by/#website" },
    "mainEntity": { "@id": (page.url | absoluteUrl(site.url)) ~ "#post" }
  } %}
  {% if breadcrumbId %}
    {% set webPage = webPage | setAttribute("breadcrumb", { "@id": breadcrumbId }) %}
  {% endif %}


  {# ШАГ 2.3: базовый BlogPosting (создаём СРАЗУ после WebPage) #}
  {% set imageUrl = image | default('/assets/images/main/bartoshevichby.png') %}
  {% set blogPosting = {
    "@type": "BlogPosting",
    "@id": (page.url | absoluteUrl(site.url)) ~ "#post",
    "url": (page.url | absoluteUrl(site.url)),
    "headline": (title.val or title) | decodeEntities | replace('"', '\\"'),
    "author": { "@id": "https://bartoshevich.by/about/#person" },
    "publisher": { "@id": "https://bartoshevich.by/about/#person" },
    "description": (description.val or description) | jsonLdText,
    "image": site.url ~ imageUrl,
    "datePublished": page.date | isoDate,
    "dateModified": last_modified_at | default(config.buildDate) | isoDate,
    "mainEntityOfPage": { "@id": (page.url | absoluteUrl(site.url)) },
    "isPartOf": { "@id": site.url ~ "/blog/" }
  } %}


 {# Опциональные поля BlogPosting #}
  {% if content %}
    {% set blogPosting = blogPosting | setAttribute("wordCount", content | decodeEntities | wordcount) %}
    {% set blogPosting = blogPosting | setAttribute("timeRequired", content | readingTimeISO) %}
  {% endif %}

 {# [CITATIONS] Обработка цитируемых источников (книг, видео, статей) #}
{% if citations and citations | length > 0 %}
  {# Готовим массив, который будет содержать полные объекты цитат #}
  {% set citationObjects = [] %}

  {# Перебираем каждую цитату из front matter #}
  {% for citation in citations %}
    {# 1. Базовый объект цитаты без url/contentUrl — их добавим ниже в зависимости от типа #}
    {% set citationObject = {
      "@type": citation.type,
      "name": citation.name
    } %}

    {# 2. URL / contentUrl / embedUrl в зависимости от типа #}
    {% if citation.type == "VideoObject" %}
      {# Для видео Google просит contentUrl или embedUrl #}
      {% if citation.url %}
        {# используем url как contentUrl, если отдельного contentUrl нет #}
        {% set citationObject = citationObject | setAttribute("contentUrl", citation.url) %}
      {% endif %}
      {% if citation.embedUrl %}
        {% set citationObject = citationObject | setAttribute("embedUrl", citation.embedUrl) %}
      {% endif %}
    {% else %}
      {# Для остальных типов достаточно обычного url #}
      {% if citation.url %}
        {% set citationObject = citationObject | setAttribute("url", citation.url) %}
      {% endif %}
    {% endif %}

    {# 3. Описание (обязательно для VideoObject) #}
    {% if citation.description %}
      {% set citationObject = citationObject | setAttribute("description", citation.description) %}
    {% elseif citation.type == "VideoObject" %}
      {# fallback, чтобы не было ворнинга "Отсутствует поле description" #}
      {% set citationObject = citationObject | setAttribute("description", citation.name) %}
    {% endif %}

    {# 3.1. Миниатюра для видео (не обязательно, но полезно) #}
    {% if citation.type == "VideoObject" and citation.thumbnailUrl %}
      {% set citationObject = citationObject | setAttribute("thumbnailUrl", citation.thumbnailUrl) %}
    {% endif %}

    {# 4. Обогащаем объект авторами (может быть несколько) #}
    {% if citation.author and citation.author | length > 0 %}
      {% set authorArray = [] %}
      {% for auth in citation.author %}
        {% set _ = authorArray.push({
          "@type": "Person",
          "name": auth.name
        }) %}
      {% endfor %}
      {% set citationObject = citationObject | setAttribute("author", authorArray) %}
    {% endif %}

    {# 5. Обогащаем объект издателем (если есть) #}
    {% if citation.publisher %}
      {% set citationObject = citationObject | setAttribute("publisher", {
        "@type": "Organization",
        "name": citation.publisher.name
      }) %}
    {% endif %}

    {# 6. uploadDate c корректным ISO-форматом и часовым поясом #}
    {% if citation.type == "VideoObject" and citation.uploadDate %}
      {# Предполагаем, что citation.uploadDate — дата/строка,
         которую isoDate умеет преобразовать в ISO 8601 с таймзоной #}
      {% set citationObject = citationObject | setAttribute("uploadDate", citation.uploadDate | isoDate) %}
    {% endif %}

    {# 7. Добавляем готовый объект цитаты в наш массив #}
    {% set _ = citationObjects.push(citationObject) %}
  {% endfor %}

  {# 8. Привязываем массив цитат к основной статье (BlogPosting) #}
  {% if citationObjects | length > 0 %}
    {% set blogPosting = blogPosting | setAttribute("citation", citationObjects) %}
  {% endif %}
{% endif %}




 
   
{# [FAQ] Обработка FAQ после создания webPage и blogPosting #}
  {% if faq %}
    {% set faqItems = [] %}
    {% for item in faq %}
      {% set faqItem = {
        "@type": "Question",
        "name": item.question,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": item.answer
        }
      } %}
      {% set _ = faqItems.push(faqItem) %}
    {% endfor %}

    {% set faqId = (page.url | absoluteUrl(site.url)) ~ "#faq" %}

    {% set faqPageSchema = {
      "@type": "FAQPage",
      "@id": faqId,
      "mainEntity": faqItems,
      "mainEntityOfPage": { "@id": (page.url | absoluteUrl(site.url)) }
    } %}
    {% set _ = schemaParts.push(faqPageSchema) %}

    {# Привязываем FAQPage как часть WebPage и BlogPosting #}
    {% set webPage = webPage | setAttribute("hasPart", { "@id": faqId }) %}
    {% set blogPosting = blogPosting | setAttribute("hasPart", { "@id": faqId }) %}
  {% endif %}



  {# [MENTIONS] Обработка упомянутых экспертов для усиления E-E-A-T #}
{% if mentions and mentions | length > 0 %}
  {# Готовим массив, который будет содержать ссылки (@id) на объекты Person #}
  {% set mentionedPersonIds = [] %}

  {# Перебираем каждого эксперта из front matter #}
  {% for person in mentions %}
    {# 1. Создаем уникальный @id для каждого Person. 
          Используем slugify, если есть, или простой replace для надежности. #}
    {% set personSlug = person.name | replace(" ", "-") | lower %}
    {% set personId = (page.url | absoluteUrl(site.url)) ~ "#person-" ~ personSlug %}

    {# 2. Собираем основной объект Person #}
    {% set personSchema = {
      "@type": "Person",
      "@id": personId,
      "name": person.name
    } %}

    {# 3. Обогащаем объект опциональными полями из front matter #}
    {% if person.jobTitle %}
      {% set personSchema = personSchema | setAttribute("jobTitle", person.jobTitle) %}
    {% endif %}

    {% if person.image %}
      {# Превращаем относительный URL картинки в абсолютный #}
      {% set personSchema = personSchema | setAttribute("image", person.image | absoluteUrl(site.url)) %}
    {% endif %}

    {% if person.affiliation %}
      {% set personSchema = personSchema | setAttribute("worksFor", {
        "@type": "Organization",
        "name": person.affiliation
      }) %}
    {% endif %}

    {% if person.profileUrl %}
      {# sameAs - ключевое поле для E-E-A-T, связывающее с авторитетными профилями #}
      {% set personSchema = personSchema | setAttribute("sameAs", person.profileUrl | arrayify) %}
    {% endif %}

    {# 4. Добавляем готовый объект Person в общий граф #}
    {% set _ = schemaParts.push(personSchema) %}

    {# 5. Добавляем ссылку на этот объект в наш массив для связи #}
    {% set _ = mentionedPersonIds.push({ "@id": personId }) %}
  {% endfor %}

  {# 6. Привязываем массив ссылок на экспертов к основной статье (BlogPosting) #}
  {% if mentionedPersonIds | length > 0 %}
    {% set blogPosting = blogPosting | setAttribute("mentions", mentionedPersonIds) %}
  {% endif %}
{% endif %}




{# [HOWTO] Обработка пошаговых руководств #}
{% if howto and howto.steps %}
  {# 1. Собираем массив шагов (steps) #}
  {% set howtoSteps = [] %}
  {% set stepCounter = 0 %} {# Общий счетчик для position, чтобы нумерация была сквозной #}
  
  {% for step in howto.steps %}
    {% set stepCounter = stepCounter + 1 %}
    
    {% if step.type == "HowToSection" %}
      {# Это секция с вложенными шагами #}
      {% set sectionSteps = [] %}
      {% for subStep in step.steps %}
        {% set subStepObject = {
          "@type": "HowToStep",
          "name": subStep.name,
          "text": subStep.text,
          "position": loop.index
        } %}
        {% set _ = sectionSteps.push(subStepObject) %}
      {% endfor %}
      
      {% set stepObject = {
        "@type": "HowToSection",
        "name": step.name,
        "position": stepCounter,
        "itemListElement": sectionSteps
      } %}

    {% else %}
      {# Это простой шаг HowToStep #}
      {% set stepObject = {
        "@type": "HowToStep",
        "name": step.name,
        "text": step.text,
        "position": stepCounter
      } %}
      {# Добавляем изображение, если оно указано #}
      {% if step.image %}
        {% set stepObject = stepObject | setAttribute("image", step.image | absoluteUrl(site.url)) %}
      {% endif %}
    {% endif %}
    
    {% set _ = howtoSteps.push(stepObject) %}
  {% endfor %}

  {# 2. Собираем финальный HowTo объект #}
  {% set howtoId = (page.url | absoluteUrl(site.url)) ~ "#howto" %}

  {% set howtoSchema = {
    "@type": "HowTo",
    "@id": howtoId,
    "name": howto.name,
    "description": howto.description,
    "step": howtoSteps
  } %}

  {# 3. Добавляем HowTo в общий граф #}
  {% set _ = schemaParts.push(howtoSchema) %}

  {# 4. Привязываем HowTo как основную сущность (mainEntity) к WebPage и BlogPosting #}
  {# Это более сильная семантическая связь, чем hasPart #}
  {% set webPage = webPage | setAttribute("mainEntity", { "@id": howtoId }) %}
  {% set blogPosting = blogPosting | setAttribute("mainEntity", { "@id": howtoId }) %}
{% endif %}






{# [BOOK] Обработка книги и рецензии #}
{# [BOOK] Обработка книги и рецензии #}
{% if book %}
  {% set bookId = (page.url | absoluteUrl(site.url)) ~ "#book" %}
  
  {# Определяем основное имя: если есть русское, берем его, иначе fallback на text/original #}
  {% set bookName = book.nameRu if book.nameRu else book.name %}
  
  {% set bookSchema = {
    "@type": "Book",
    "@id": bookId,
    "name": bookName,
    "image": site.url ~ book.image
  } %}
  
  {# Если есть русское имя, то book.name (английское) записать в alternateName (если оно отличается) #}
  {% if book.nameRu and book.name and book.name != book.nameRu %}
     {% set bookSchema = bookSchema | setAttribute("alternateName", book.name) %}
  {% endif %}

  {# Логика для автора #}
  {% set authorName = book.authorRu if book.authorRu else book.author %}
  {% set authorObj = { "@type": "Person", "name": authorName } %}
  
  {% if book.authorRu and book.author and book.author != book.authorRu %}
      {% set authorObj = authorObj | setAttribute("alternateName", book.author) %}
  {% endif %}
  
  {% set bookSchema = bookSchema | setAttribute("author", authorObj) %}
  
  {% if book.isbn %}
     {% set bookSchema = bookSchema | setAttribute("isbn", book.isbn) %}
  {% endif %}
  {% if book.sameAs %}
     {% set bookSchema = bookSchema | setAttribute("sameAs", book.sameAs) %}
  {% endif %}
  
  {% set _ = schemaParts.push(bookSchema) %}

  {% if book.review %}
    {% set reviewId = (page.url | absoluteUrl(site.url)) ~ "#review" %}
    {% set reviewSchema = {
       "@type": "Review",
       "@id": reviewId,
       "itemReviewed": { "@id": bookId },
       "reviewRating": {
         "@type": "Rating",
         "ratingValue": book.review.rating,
         "bestRating": 5,
         "worstRating": 1
       },
       "reviewBody": book.review.body,
       "author": { "@id": "https://bartoshevich.by/about/#person" }
    } %}
    {% set _ = schemaParts.push(reviewSchema) %}
    
    {# Linking to BlogPosting via hasPart #}
    {% set reviewPart = { "@id": reviewId } %}
    
    {% if blogPosting.hasPart %}
       {% if blogPosting.hasPart.length %} 
          {% set _ = blogPosting.hasPart.push(reviewPart) %}
       {% else %}
          {% set newParts = [blogPosting.hasPart, reviewPart] %}
          {% set blogPosting = blogPosting | setAttribute("hasPart", newParts) %}
       {% endif %}
    {% else %}
       {% set blogPosting = blogPosting | setAttribute("hasPart", reviewPart) %}
    {% endif %}
  {% endif %}
{% endif %}


  {# Обработка постов с фильмами #}
  {% if mainEntitySource == "films" and films and films.items %}
    {% set movieItems = [] %}
    {% for film in films.items %}
      {% set itemType = "TVSeries" if film.item_type == "TVSeries" else "Movie" %}
      {% set movieObject = {
        "@type": itemType,
        "url": site.url ~ page.url ~ "#" ~ film.id,
        "name": film.title_ru | replace('"', '\\"'),
        "alternateName": film.title_en | replace('"', '\\"'),
        "image": film.image if film.image else "https://i.ytimg.com/vi/" ~ film.trailer_yt_id ~ "/maxresdefault.jpg",
        "description": film.description | replace('"', '\\"'),
        "datePublished": film.year | string,
        "director": { "@type": "Person", "name": film.director.name }
      } %}

      {% if film.imdb_id %}
        {% set imdbUrl = "https://www.imdb.com/title/" ~ film.imdb_id ~ "/" %}
        {% set movieObject = movieObject | setAttribute("sameAs", imdbUrl) %}
      {% endif %}

      {% if film.reviews and (film.reviews | length) > 0 %}
        {% set reviewList = [] %}
        {% for review in film.reviews %}
          {% set reviewObject = { "@type": "Review", "reviewBody": review.text, "reviewRating": { "@type": "Rating", "ratingValue": review.rating, "bestRating": 10, "worstRating": 1 }, "author": { "@type": "Person", "name": review.author.name } } %}
          {% set _ = reviewList.push(reviewObject) %}
        {% endfor %}
        {% set movieObject = movieObject | setAttribute("review", reviewList) %}
      {% endif %}

      {% if film.imdb_rating and film.imdb_rating_count %}
        {% set movieObject = movieObject | setAttribute("aggregateRating", { "@type": "AggregateRating", "ratingValue": film.imdb_rating, "ratingCount": film.imdb_rating_count, "bestRating": 10, "worstRating": 1 }) %}
      {% elif film.imdb_rating %}
        {% set imdbReview = { "@type": "Review", "author": { "@type": "Organization", "name": "IMDb" }, "reviewBody": "Рейтинг IMDb: " ~ film.imdb_rating ~ "/10", "reviewRating": { "@type": "Rating", "ratingValue": film.imdb_rating, "bestRating": 10, "worstRating": 1 } } %}
        {% set existingReviews = movieObject.review or [] %}
        {% set _ = existingReviews.push(imdbReview) %}
        {% set movieObject = movieObject | setAttribute("review", existingReviews) %}
      {% endif %}
      
      {% set listItem = { "@type": "ListItem", "position": loop.index, "item": movieObject } %}
      {% set _ = movieItems.push(listItem) %}
    {% endfor %}

    {% set movieItemList = {
      "@type": "ItemList",
      "name": (title.val or title) | decodeEntities,
      "itemListOrder": "https://schema.org/ItemListOrderAscending",
      "numberOfItems": movieItems | length,
      "itemListElement": movieItems
    } %}
    
    {# Размещаем ItemList как mainEntity на WebPage, перезаписывая возможную ссылку на FAQ, т.к. фильмы важнее #}
    {% set webPage = webPage | setAttribute("mainEntity", movieItemList) %}
  {% endif %}



{# [SPEAKABLE] Базовые селекторы + опциональные #}
{% set speakableSelectors = ["h1", ".heading--beta"] %}

{% if hasPullQuote %}
  {% set _ = speakableSelectors.push(".pull-quote") %}
{% endif %}

{% set speakable = {
  "@type": "SpeakableSpecification",
  "cssSelector": speakableSelectors
} %}

  {% set webPage = webPage | setAttribute("speakable", speakable) %}
  {% set blogPosting = blogPosting | setAttribute("speakable", speakable) %}


  {# Отправляем финальный, полностью собранный WebPage в граф #}
  {% set _ = schemaParts.push(webPage) %}

 
  {# Отправляем финальный, полностью собранный BlogPosting в граф #}
  {% set _ = schemaParts.push(blogPosting) %}

{% endif %}
